{% extends "manager/manager.html.twig" %}

{% block title %}Calendario - {{ client_name }}{% endblock %}

{% block heads %}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
{% endblock %}

{% block section_content %}
<div class="col-10">
    <div id="calendar"></div>
</div>
<div class="col-4"></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');

    var professionals = [
        {
            id: 1,
            name: 'Francisca'
        },
        {
            id: 2,
            name: 'Juan'
        },
        {
            id: 3,
            name: 'Carolina'
        },
        {
            id: 4,
            name: 'Sandra'
        },
        {
            id: 5,
            name: 'Lourdes'
        },
    ]; // Lista de personas
    var personColors = ['#ffadad', '#ffdda1', '#b0e57c', '#34f290', '#F165E7']; // Colores para cada persona
    var events = [
        { id: '1', title: 'Consulta A', start: '2025-02-20T11:00:00', end: '2025-02-20T12:00:00', extendedProps: { professionalId: 1 } },
        { id: '2', title: 'Consulta B', start: '2025-02-20T16:30:00', end: '2025-02-20T17:30:00', extendedProps: { professionalId: 2 } },
        { id: '3', title: 'Consulta C', start: '2025-02-20T13:00:00', end: '2025-02-20T14:00:00', extendedProps: { professionalId: 3 } },
        { id: '4', title: 'Consulta D', start: '2025-02-19T09:30:00', end: '2025-02-19T10:30:00', extendedProps: { professionalId: 4 } },
        { id: '5', title: 'Consulta D', start: '2025-02-19T14:00:00', end: '2025-02-19T15:00:00', extendedProps: { professionalId: 5 } }
    ]

    var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'es',
        firstDay: 1, // Lunes como primer día de la semana
        initialView: 'dayGridMonth', // Vista inicial: mes
        slotDuration: '00:30:00', // Intervalo de 30 min por fila
        slotLabelInterval: '01:00:00', // Etiqueta cada hora
        slotMinTime: "07:00:00", // Hora mínima del día
        slotMaxTime: "21:00:00", // Hora máxima del día
        nowIndicator: true, // Muestra una línea en la hora actual
        allDaySlot: false, // Ocultar la fila de "Todo el día"
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,  // Permite mover eventos
        selectable: true, // Permite crear eventos
        selectMirror: true,
        select: function(info) { 
            let title = prompt("Nombre del evento:");
            if (title) {
                calendar.addEvent({
                    title: title,
                    start: info.startStr,
                    end: info.endStr,
                    allDay: info.allDay
                });
            }
            calendar.unselect();
        },
        eventDragStart: function(info) {
            if (info.view.type === 'timeGridDay') {
                replaceEventElementToPersonColumn(info.el.parentNode, info.event.extendedProps.professionalId);
            }
        },
        eventDragStop(info) {
            if (info.view.type === 'timeGridDay') {
                replaceEventElementToPersonColumn(info.el.parentNode, info.event.extendedProps.professionalId);
            }
        },
        eventDrop: function(info) {
            if (info.view.type === 'timeGridDay') {
                replaceEventElementToPersonColumn(info.el.parentNode, info.event.extendedProps.professionalId);
            }
            alert('Evento movido a: ' + info.event.start.toISOString());
        },
        events: events,
        datesSet: function (info) {
            if (info.view.type === 'timeGridDay') {
                //console.log("dataSet (in IF)", professionals);
                createColumnsForPersons(professionals, document.querySelector('.fc-day .fc-timegrid-col-events'));
            }
        },
        eventDidMount: function(info) {
            if (info.view.type === 'timeGridDay') {
                //console.log("eventDidMount (in IF)", info.el.parentNode, info.event.extendedProps.professionalId);
                replaceEventElementToPersonColumn(info.el.parentNode, info.event.extendedProps.professionalId);
            }
        }
    });

    calendar.render();

    function replaceEventElementToPersonColumn(eventElement, personId)
    {
        requestAnimationFrame(() => {
            destinationCol = document.getElementById('col-professional-' + personId);
            destinationCol.appendChild(eventElement);
        });
    }

    function createColumnsForPersons(persons, originalColumnElement)
    {
        emptyCalendarColElement = originalColumnElement.cloneNode(true);
        while (emptyCalendarColElement.firstChild) {
            emptyCalendarColElement.removeChild(emptyCalendarColElement.firstChild);
        }
        personsCount = persons.length;
        counter = 0;
        while (counter < personsCount - 1) {
            newCalendarColElement = emptyCalendarColElement.cloneNode(true);
            newCalendarColElement.id = 'col-professional-' + persons[counter]['id'];
            newCalendarColElement.style.setProperty('margin-left', (100 / personsCount) * (counter) + '%');
            newCalendarColElement.style.width = (100 / personsCount) + '%';
            originalColumnElement.parentElement.insertBefore(newCalendarColElement, originalColumnElement);

            counter++;
        }
        originalColumnElement.id = 'col-professional-' + persons[counter]['id'];
        originalColumnElement.style.setProperty('margin-left', (100 / personsCount) * (counter) + '%');
        originalColumnElement.style.width = (100 / personsCount) + '%';
    }
});
</script>
{% endblock %}

{% block styles %}
    {{ parent() }}
    /* Contenedor general del calendario */
    #calendar { 
        max-width: 1200px; /* Aumentado para que se vea más grande */
        min-height: 700px; /* Más altura para que se aproveche mejor la pantalla */
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        font-family: 'Roboto', sans-serif;
    }

    /* Ajustamos la vista de calendario */
    .fc {
        border-radius: var(--border-radius);
    }

    /* Barra de herramientas del calendario */
    .fc-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        font-size: 18px;
    }

    /* Botones del calendario */
    .fc-button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        padding: 12px 16px;
        font-size: 16px; /* Más grande para mejor usabilidad */
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 3px 7px rgba(0, 0, 0, 0.1);
    }

    .fc-button:hover {
        background: var(--accent-color);
    }

    /* Botón activo */
    .fc-button-active {
        background: var(--accent-color);
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    }

    /* Cabecera de los días */
    .fc-col-header-cell {
        background: var(--background-color);
        color: var(--text-color);
        font-weight: bold;
        padding: 12px 0;
        font-size: 16px;
    }

    /* Celda de cada día */
    .fc-daygrid-day {
        border: 1px solid var(--secondary-color);
        transition: background 0.2s ease-in-out;
        font-size: 14px;
        padding: 15px;
    }

    .fc-daygrid-day:hover {
        background: var(--background-color);
    }

    /* Eventos */
    .fc-event {
        background: var(--primary-color);
        color: white;
        border-radius: var(--border-radius);
        padding: 8px 10px; /* Más espacio dentro de los eventos */
        font-size: 14px; /* Mayor legibilidad */
        font-weight: bold;
        box-shadow: 0 3px 7px rgba(0, 0, 0, 0.15);
    }

    /* Evento cuando se está arrastrando */
    .fc-event-dragging {
        opacity: 0.7;
    }

    /* Evento seleccionado */
    .fc-event-selected {
        background: var(--accent-color);
        border: 2px solid var(--secondary-color);
    }

    /* Vista semanal y diaria */
    .fc-timeGridWeek-view, .fc-timeGridDay-view {
        background: white;
    }

    /* Scroll en la vista semanal/diaria */
    .fc-scroller {
        overflow-y: auto;
    }

    /* Vista de lista */
    .fc-list {
        background: white;
        border-radius: var(--border-radius);
    }

    .fc-list-event {
        background: var(--primary-color);
        color: white;
        border-radius: var(--border-radius);
        padding: 10px;
    }

    /* Día actual */
    .fc-day-today {
        background: color-mix(in srgb, var(--primary-color) 10%, white 90%);
        font-weight: bold;
    }

    /* Días del fin de semana */
    .fc-day-sat, .fc-day-sun {
        background-color: #F7F7F7; /* Un tono suave de rojo */
    }


    

    /* Posicionamiento de eventos por persona */
/*    .fc-timeGridDay-view .event-person-0 { transform: translateX(0%); width: 20%;}
    .fc-timeGridDay-view .event-person-1 { transform: translateX(102.5%); width: 20%;}
    .fc-timeGridDay-view .event-person-2 { transform: translateX(205%); width: 20%;}
    .fc-timeGridDay-view .event-person-3 { transform: translateX(307.5%); width: 20%;}
    .fc-timeGridDay-view .event-person-4 { transform: translateX(410%); width: 20%;}*/
{% endblock %}